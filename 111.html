<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>انتخابگر تاریخ شمسی ساده</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Vazirmatn', Tahoma, sans-serif; background: #fafbfd; direction: rtl; padding: 20px;}
    .datepicker-container { position: relative; width: 260px;}
    .calendar-panel {
      position: absolute; top: 45px; right: 0; background: #fff; z-index: 11; border: 1px solid #e0e0e0; box-shadow: 0 2px 16px 0 #eee; border-radius: 8px; padding: 12px; display: none;
      min-width: 230px;
    }
    .calendar-panel.show { display: block; }
    .calendar-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
    }
    .calendar-header button { background: #f4f4f5; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;}
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;}
    .calendar-days span { text-align: center; font-size: 12px; color: #888; }
    .calendar-dates { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;}
    .calendar-dates button {
      background: none; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; height: 30px; width: 30px;
      transition: background 0.2s;
    }
    .calendar-dates button:hover, .calendar-dates button.selected { background: #2196f3; color: #fff; }
    .calendar-dates button.today { border: 1px solid #2196f3; }
    input[readonly] { cursor: pointer; background-color: #fffefe;}
  </style>
</head>
<body>
  <form id="myForm" autocomplete="off">
    <label for="datepicker">تاریخ:</label>
    <div class="datepicker-container">
      <input id="datepicker" name="date" type="text" readonly placeholder="تاریخ را انتخاب کنید" />
      <div id="calendar" class="calendar-panel"></div>
    </div>
    <br>
    <button type="submit">ثبت</button>
  </form>
  
  <script>
    // ابزار تبدیل میلادی به جلالی (شمسی) و برعکس
    function toJalali(gy, gm, gd){
      var g_d_m, jy, jm, jd, gy2, days;
      g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334];
      gy2=(gm>2)?(gy+1):gy;
      days = 355666+ (365*gy) + (((gy2+3)/4)|0) - (((gy2+99)/100)|0) + (((gy2+399)/400)|0) + gd + g_d_m[gm-1];
      jy = -1595+ (33*((days/12053)|0));
      days %= 12053;
      jy += 4*((days/1461)|0);
      days %= 1461;
      if(days>365){
        jy += ((days-1)/365)|0;
        days = (days-1)%365;
      }
      var sal_a=[0,31,31,31,31,31,31,30,30,30,30,30,29];
      for(jm=1; jm<=12 && days>=sal_a[jm]; jm++) days -= sal_a[jm];
      jd = days+1;
      return [jy, jm, jd];
    }
    function toGregorian(jy, jm, jd){
      var gy, days, sal_a, gm, gd;
      jy += 1595;
      days = -355668 + (365*jy) + ((jy/33)|0)*8 + (((jy%33)+3)/4)|0 + jd + ((jm<7)?((jm-1)*31):(((jm-7)*30)+186));
      gy = 400 * ((days/146097)|0);
      days %= 146097;
      if(days > 36524){
        gy += 100 * ((--days)/36524|0);
        days %= 36524;
        if(days >= 365) days++;
      }
      gy += 4 * ((days/1461)|0);
      days %= 1461;
      if(days > 365){
        gy += ((days-1)/365)|0;
        days = (days-1)%365;
      }
      for(gm=1; gm<=12 && days >= (gm==2?28:(((gm<=7 && gm%2==1)||(gm>=8 && gm%2==0))?31:30)); gm++)
        days -= (gm==2?28:(((gm<=7 && gm%2==1)||(gm>=8 && gm%2==0))?31:30));
      gd = days+1;
      return [gy, gm, gd];
    }

    function pad(n) { return (n<10 ? '0' : '') + n; }

    // مقادیر اصلی تقویم
    const weekDays = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
    const persianMonths = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];

    function daysInJalaliMonth(y, m) {
      return m <= 6 ? 31 : m <= 11 ? 30 : (leapJalali(y) ? 30 : 29);
    }

    function leapJalali(jy) {
      return ((((jy - ((jy>0)?474:473)) % 2820) + 474 + 38)*682)%2816 < 682;
    }

    // تنظیمات صفحه و تقویم
    const input = document.getElementById('datepicker');
    const calendar = document.getElementById('calendar');
    let selected = null, viewYear, viewMonth;

    // استفاده از تاریخ امروز
    let today = new Date();
    let [jy, jm, jd] = toJalali(today.getFullYear(), today.getMonth()+1, today.getDate());

    function openCalendar() {
      calendar.innerHTML = renderCalendar(viewYear, viewMonth, selected);
      calendar.classList.add('show');
    }

    function closeCalendar() {
      setTimeout( () => calendar.classList.remove('show'), 100);
    }

    // نمایش تقویم
    function renderCalendar(year, month, selectedDate) {
      let days = daysInJalaliMonth(year, month);

      // روز شروع ماه
      let [gYear, gMonth, gDay] = toGregorian(year, month, 1);
      let start = new Date(gYear, gMonth-1, gDay).getDay();
      // هفته فارسی از شنبه: اگر جمعه بود 6
      start = (start+1)%7;
      let html = `
        <div class="calendar-header">
          <button id="prev">&lt;</button>
          <span>${persianMonths[month-1]} ${year}</span>
          <button id="next">&gt;</button>
        </div>
        <div class="calendar-days">
          ${weekDays.map(d => `<span>${d}</span>`).join('')}
        </div>
        <div class="calendar-dates">
      `;
      let cnt = 0;
      for(let i=0; i<start; i++) {
        html += `<span></span>`;
        cnt++;
      }
      for(let d=1; d<=days; d++) {
        let classes = [];
        if(selectedDate && selectedDate[0]===year && selectedDate[1]===month && selectedDate[2]===d) classes.push('selected');
        if(year===jy && month===jm && d===jd) classes.push('today');
        html += `<button type="button" class="${classes.join(' ')}" data-val="${year}/${pad(month)}/${pad(d)}">${d}</button>`;
        cnt++;
      }
      while(cnt%7!=0) { html += `<span></span>`; cnt++; }

      html += '</div>';
      return html;
    }

    function setInput(val) {
      input.value = val;
    }

    input.addEventListener('click', function(e){
      viewYear = jy;
      viewMonth = jm;
      openCalendar();
    });

    calendar.addEventListener('mousedown', function(e){
      e.preventDefault();
    });

    document.addEventListener('mousedown', function(e){
      if(!calendar.contains(e.target) && e.target!==input) {
        closeCalendar();
      }
    });

    calendar.addEventListener('click', function(e){
      if(!e.target) return;
      if(e.target.id === 'prev') {
        if(viewMonth===1) { viewYear--; viewMonth=12; } else viewMonth--;
        openCalendar();
      }
      else if(e.target.id === 'next') {
        if(viewMonth===12) { viewYear++; viewMonth=1; } else viewMonth++;
        openCalendar();
      }
      else if(e.target.tagName==='BUTTON' && e.target.hasAttribute('data-val')) {
        setInput(e.target.getAttribute('data-val'));
        selected = [viewYear, viewMonth, +e.target.textContent];
        closeCalendar();
      }
    });

    // غیر فعال کردن تایپ دستی
    input.setAttribute('readonly','readonly');
  </script>
</body>
</html>
